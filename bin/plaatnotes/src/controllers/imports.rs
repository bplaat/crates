/*
 * Copyright (c) 2026 Bastiaan van der Plaat
 *
 * SPDX-License-Identifier: MIT
 */

use base64::prelude::*;
use from_derive::FromStruct;
use small_http::{Request, Response, Status};
use validate::Validate;

use crate::api;
use crate::context::Context;
use crate::imports::google_keep;

#[derive(Validate, FromStruct)]
#[from_struct(api::ImportGoogleKeepBody)]
struct ImportGoogleKeepBody {
    #[validate(ascii, length(min = 1))]
    file: String,
}

pub(crate) fn imports_google_keep(req: &Request, ctx: &Context) -> Response {
    // Check authentication
    let user = match &ctx.auth_user {
        Some(user) => user,
        None => return Response::with_status(Status::Unauthorized),
    };

    // Parse and validate body
    let body = match serde_urlencoded::from_bytes::<api::ImportGoogleKeepBody>(
        req.body.as_deref().unwrap_or(&[]),
    ) {
        Ok(body) => Into::<ImportGoogleKeepBody>::into(body),
        Err(_) => return Response::with_status(Status::BadRequest),
    };
    if let Err(report) = body.validate() {
        return Response::with_status(Status::BadRequest).json(Into::<api::Report>::into(report));
    }

    // Decode base64 zip
    let zip_bytes = match BASE64_STANDARD.decode(body.file.as_bytes()) {
        Ok(b) => b,
        Err(_) => return Response::with_status(Status::BadRequest),
    };

    // Import notes
    let count = google_keep::import_from_zip_bytes(&zip_bytes, ctx, user.id);

    Response::with_json(api::ImportGoogleKeepResponse {
        count: count as i64,
    })
}

// MARK: Tests
#[cfg(test)]
mod test {
    use super::*;
    use crate::context::Context;
    use crate::router;
    use crate::test_utils::create_test_user_with_session;

    // Takeout/Keep/note0.json = {"title": "My Note", "textContent": "Hello world", ...}
    // Takeout/Keep/note1.json = {"title": "Second",  "textContent": "Body 2", ...}
    #[rustfmt::skip]
    const TWO_NOTES_ZIP: &[u8] = &[0x50, 0x4b, 0x03, 0x04, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0xae, 0x61, 0x5c, 0xef, 0x2b, 0x61, 0x84, 0xc5, 0x00, 0x00, 0x00, 0xc5, 0x00, 0x00, 0x00, 0x17, 0x00, 0x00, 0x00, 0x54, 0x61, 0x6b, 0x65, 0x6f, 0x75, 0x74, 0x2f, 0x4b, 0x65, 0x65, 0x70, 0x2f, 0x6e, 0x6f, 0x74, 0x65, 0x30, 0x2e, 0x6a, 0x73, 0x6f, 0x6e, 0x7b, 0x22, 0x74, 0x69, 0x74, 0x6c, 0x65, 0x22, 0x3a, 0x20, 0x22, 0x4d, 0x79, 0x20, 0x4e, 0x6f, 0x74, 0x65, 0x22, 0x2c, 0x20, 0x22, 0x74, 0x65, 0x78, 0x74, 0x43, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, 0x22, 0x3a, 0x20, 0x22, 0x48, 0x65, 0x6c, 0x6c, 0x6f, 0x20, 0x77, 0x6f, 0x72, 0x6c, 0x64, 0x22, 0x2c, 0x20, 0x22, 0x69, 0x73, 0x50, 0x69, 0x6e, 0x6e, 0x65, 0x64, 0x22, 0x3a, 0x20, 0x66, 0x61, 0x6c, 0x73, 0x65, 0x2c, 0x20, 0x22, 0x69, 0x73, 0x41, 0x72, 0x63, 0x68, 0x69, 0x76, 0x65, 0x64, 0x22, 0x3a, 0x20, 0x66, 0x61, 0x6c, 0x73, 0x65, 0x2c, 0x20, 0x22, 0x69, 0x73, 0x54, 0x72, 0x61, 0x73, 0x68, 0x65, 0x64, 0x22, 0x3a, 0x20, 0x66, 0x61, 0x6c, 0x73, 0x65, 0x2c, 0x20, 0x22, 0x63, 0x72, 0x65, 0x61, 0x74, 0x65, 0x64, 0x54, 0x69, 0x6d, 0x65, 0x73, 0x74, 0x61, 0x6d, 0x70, 0x55, 0x73, 0x65, 0x63, 0x22, 0x3a, 0x20, 0x31, 0x37, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x2c, 0x20, 0x22, 0x75, 0x73, 0x65, 0x72, 0x45, 0x64, 0x69, 0x74, 0x65, 0x64, 0x54, 0x69, 0x6d, 0x65, 0x73, 0x74, 0x61, 0x6d, 0x70, 0x55, 0x73, 0x65, 0x63, 0x22, 0x3a, 0x20, 0x31, 0x37, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x7d, 0x50, 0x4b, 0x03, 0x04, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0xae, 0x61, 0x5c, 0x0c, 0xae, 0x60, 0x1b, 0xbf, 0x00, 0x00, 0x00, 0xbf, 0x00, 0x00, 0x00, 0x17, 0x00, 0x00, 0x00, 0x54, 0x61, 0x6b, 0x65, 0x6f, 0x75, 0x74, 0x2f, 0x4b, 0x65, 0x65, 0x70, 0x2f, 0x6e, 0x6f, 0x74, 0x65, 0x31, 0x2e, 0x6a, 0x73, 0x6f, 0x6e, 0x7b, 0x22, 0x74, 0x69, 0x74, 0x6c, 0x65, 0x22, 0x3a, 0x20, 0x22, 0x53, 0x65, 0x63, 0x6f, 0x6e, 0x64, 0x22, 0x2c, 0x20, 0x22, 0x74, 0x65, 0x78, 0x74, 0x43, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, 0x22, 0x3a, 0x20, 0x22, 0x42, 0x6f, 0x64, 0x79, 0x20, 0x32, 0x22, 0x2c, 0x20, 0x22, 0x69, 0x73, 0x50, 0x69, 0x6e, 0x6e, 0x65, 0x64, 0x22, 0x3a, 0x20, 0x66, 0x61, 0x6c, 0x73, 0x65, 0x2c, 0x20, 0x22, 0x69, 0x73, 0x41, 0x72, 0x63, 0x68, 0x69, 0x76, 0x65, 0x64, 0x22, 0x3a, 0x20, 0x66, 0x61, 0x6c, 0x73, 0x65, 0x2c, 0x20, 0x22, 0x69, 0x73, 0x54, 0x72, 0x61, 0x73, 0x68, 0x65, 0x64, 0x22, 0x3a, 0x20, 0x66, 0x61, 0x6c, 0x73, 0x65, 0x2c, 0x20, 0x22, 0x63, 0x72, 0x65, 0x61, 0x74, 0x65, 0x64, 0x54, 0x69, 0x6d, 0x65, 0x73, 0x74, 0x61, 0x6d, 0x70, 0x55, 0x73, 0x65, 0x63, 0x22, 0x3a, 0x20, 0x31, 0x37, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x2c, 0x20, 0x22, 0x75, 0x73, 0x65, 0x72, 0x45, 0x64, 0x69, 0x74, 0x65, 0x64, 0x54, 0x69, 0x6d, 0x65, 0x73, 0x74, 0x61, 0x6d, 0x70, 0x55, 0x73, 0x65, 0x63, 0x22, 0x3a, 0x20, 0x31, 0x37, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x7d, 0x50, 0x4b, 0x01, 0x02, 0x14, 0x03, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0xae, 0x61, 0x5c, 0xef, 0x2b, 0x61, 0x84, 0xc5, 0x00, 0x00, 0x00, 0xc5, 0x00, 0x00, 0x00, 0x17, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x01, 0x00, 0x00, 0x00, 0x00, 0x54, 0x61, 0x6b, 0x65, 0x6f, 0x75, 0x74, 0x2f, 0x4b, 0x65, 0x65, 0x70, 0x2f, 0x6e, 0x6f, 0x74, 0x65, 0x30, 0x2e, 0x6a, 0x73, 0x6f, 0x6e, 0x50, 0x4b, 0x01, 0x02, 0x14, 0x03, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0xae, 0x61, 0x5c, 0x0c, 0xae, 0x60, 0x1b, 0xbf, 0x00, 0x00, 0x00, 0xbf, 0x00, 0x00, 0x00, 0x17, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x01, 0xfa, 0x00, 0x00, 0x00, 0x54, 0x61, 0x6b, 0x65, 0x6f, 0x75, 0x74, 0x2f, 0x4b, 0x65, 0x65, 0x70, 0x2f, 0x6e, 0x6f, 0x74, 0x65, 0x31, 0x2e, 0x6a, 0x73, 0x6f, 0x6e, 0x50, 0x4b, 0x05, 0x06, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x02, 0x00, 0x8a, 0x00, 0x00, 0x00, 0xee, 0x01, 0x00, 0x00, 0x00, 0x00];

    // Takeout/Keep/note0.json = {"title": "", "textContent": "", ...}  (empty â†’ skipped)
    // Takeout/Keep/note1.json = {"title": "Real", "textContent": "Content", ...}
    #[rustfmt::skip]
    const EMPTY_AND_VALID_ZIP: &[u8] = &[0x50, 0x4b, 0x03, 0x04, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0xae, 0x61, 0x5c, 0x6c, 0x74, 0xa1, 0x66, 0xb3, 0x00, 0x00, 0x00, 0xb3, 0x00, 0x00, 0x00, 0x17, 0x00, 0x00, 0x00, 0x54, 0x61, 0x6b, 0x65, 0x6f, 0x75, 0x74, 0x2f, 0x4b, 0x65, 0x65, 0x70, 0x2f, 0x6e, 0x6f, 0x74, 0x65, 0x30, 0x2e, 0x6a, 0x73, 0x6f, 0x6e, 0x7b, 0x22, 0x74, 0x69, 0x74, 0x6c, 0x65, 0x22, 0x3a, 0x20, 0x22, 0x22, 0x2c, 0x20, 0x22, 0x74, 0x65, 0x78, 0x74, 0x43, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, 0x22, 0x3a, 0x20, 0x22, 0x22, 0x2c, 0x20, 0x22, 0x69, 0x73, 0x50, 0x69, 0x6e, 0x6e, 0x65, 0x64, 0x22, 0x3a, 0x20, 0x66, 0x61, 0x6c, 0x73, 0x65, 0x2c, 0x20, 0x22, 0x69, 0x73, 0x41, 0x72, 0x63, 0x68, 0x69, 0x76, 0x65, 0x64, 0x22, 0x3a, 0x20, 0x66, 0x61, 0x6c, 0x73, 0x65, 0x2c, 0x20, 0x22, 0x69, 0x73, 0x54, 0x72, 0x61, 0x73, 0x68, 0x65, 0x64, 0x22, 0x3a, 0x20, 0x66, 0x61, 0x6c, 0x73, 0x65, 0x2c, 0x20, 0x22, 0x63, 0x72, 0x65, 0x61, 0x74, 0x65, 0x64, 0x54, 0x69, 0x6d, 0x65, 0x73, 0x74, 0x61, 0x6d, 0x70, 0x55, 0x73, 0x65, 0x63, 0x22, 0x3a, 0x20, 0x31, 0x37, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x2c, 0x20, 0x22, 0x75, 0x73, 0x65, 0x72, 0x45, 0x64, 0x69, 0x74, 0x65, 0x64, 0x54, 0x69, 0x6d, 0x65, 0x73, 0x74, 0x61, 0x6d, 0x70, 0x55, 0x73, 0x65, 0x63, 0x22, 0x3a, 0x20, 0x31, 0x37, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x7d, 0x50, 0x4b, 0x03, 0x04, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0xae, 0x61, 0x5c, 0x13, 0xa7, 0xd9, 0x1e, 0xbe, 0x00, 0x00, 0x00, 0xbe, 0x00, 0x00, 0x00, 0x17, 0x00, 0x00, 0x00, 0x54, 0x61, 0x6b, 0x65, 0x6f, 0x75, 0x74, 0x2f, 0x4b, 0x65, 0x65, 0x70, 0x2f, 0x6e, 0x6f, 0x74, 0x65, 0x31, 0x2e, 0x6a, 0x73, 0x6f, 0x6e, 0x7b, 0x22, 0x74, 0x69, 0x74, 0x6c, 0x65, 0x22, 0x3a, 0x20, 0x22, 0x52, 0x65, 0x61, 0x6c, 0x22, 0x2c, 0x20, 0x22, 0x74, 0x65, 0x78, 0x74, 0x43, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, 0x22, 0x3a, 0x20, 0x22, 0x43, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, 0x22, 0x2c, 0x20, 0x22, 0x69, 0x73, 0x50, 0x69, 0x6e, 0x6e, 0x65, 0x64, 0x22, 0x3a, 0x20, 0x66, 0x61, 0x6c, 0x73, 0x65, 0x2c, 0x20, 0x22, 0x69, 0x73, 0x41, 0x72, 0x63, 0x68, 0x69, 0x76, 0x65, 0x64, 0x22, 0x3a, 0x20, 0x66, 0x61, 0x6c, 0x73, 0x65, 0x2c, 0x20, 0x22, 0x69, 0x73, 0x54, 0x72, 0x61, 0x73, 0x68, 0x65, 0x64, 0x22, 0x3a, 0x20, 0x66, 0x61, 0x6c, 0x73, 0x65, 0x2c, 0x20, 0x22, 0x63, 0x72, 0x65, 0x61, 0x74, 0x65, 0x64, 0x54, 0x69, 0x6d, 0x65, 0x73, 0x74, 0x61, 0x6d, 0x70, 0x55, 0x73, 0x65, 0x63, 0x22, 0x3a, 0x20, 0x31, 0x37, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x2c, 0x20, 0x22, 0x75, 0x73, 0x65, 0x72, 0x45, 0x64, 0x69, 0x74, 0x65, 0x64, 0x54, 0x69, 0x6d, 0x65, 0x73, 0x74, 0x61, 0x6d, 0x70, 0x55, 0x73, 0x65, 0x63, 0x22, 0x3a, 0x20, 0x31, 0x37, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x7d, 0x50, 0x4b, 0x01, 0x02, 0x14, 0x03, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0xae, 0x61, 0x5c, 0x6c, 0x74, 0xa1, 0x66, 0xb3, 0x00, 0x00, 0x00, 0xb3, 0x00, 0x00, 0x00, 0x17, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x01, 0x00, 0x00, 0x00, 0x00, 0x54, 0x61, 0x6b, 0x65, 0x6f, 0x75, 0x74, 0x2f, 0x4b, 0x65, 0x65, 0x70, 0x2f, 0x6e, 0x6f, 0x74, 0x65, 0x30, 0x2e, 0x6a, 0x73, 0x6f, 0x6e, 0x50, 0x4b, 0x01, 0x02, 0x14, 0x03, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0xae, 0x61, 0x5c, 0x13, 0xa7, 0xd9, 0x1e, 0xbe, 0x00, 0x00, 0x00, 0xbe, 0x00, 0x00, 0x00, 0x17, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x01, 0xe8, 0x00, 0x00, 0x00, 0x54, 0x61, 0x6b, 0x65, 0x6f, 0x75, 0x74, 0x2f, 0x4b, 0x65, 0x65, 0x70, 0x2f, 0x6e, 0x6f, 0x74, 0x65, 0x31, 0x2e, 0x6a, 0x73, 0x6f, 0x6e, 0x50, 0x4b, 0x05, 0x06, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x02, 0x00, 0x8a, 0x00, 0x00, 0x00, 0xdb, 0x01, 0x00, 0x00, 0x00, 0x00];

    fn post_import(
        router: &small_router::Router<crate::context::Context>,
        token: &str,
        zip: &[u8],
    ) -> Response {
        let file_b64 = BASE64_STANDARD.encode(zip);
        let body = format!(
            "file={}",
            file_b64
                .replace('+', "%2B")
                .replace('/', "%2F")
                .replace('=', "%3D")
        );
        router.handle(
            &Request::post("http://localhost/api/imports/google-keep")
                .header("Authorization", format!("Bearer {token}"))
                .body(body),
        )
    }

    #[test]
    fn test_imports_google_keep() {
        let ctx = Context::with_test_database();
        let router = router(ctx.clone());
        let (_, token) = create_test_user_with_session(&ctx);

        let res = post_import(&router, &token, TWO_NOTES_ZIP);
        assert_eq!(res.status, Status::Ok);
        let resp = serde_json::from_slice::<api::ImportGoogleKeepResponse>(&res.body).unwrap();
        assert_eq!(resp.count, 2);
    }

    #[test]
    fn test_imports_google_keep_empty_notes_skipped() {
        let ctx = Context::with_test_database();
        let router = router(ctx.clone());
        let (_, token) = create_test_user_with_session(&ctx);

        let res = post_import(&router, &token, EMPTY_AND_VALID_ZIP);
        assert_eq!(res.status, Status::Ok);
        let resp = serde_json::from_slice::<api::ImportGoogleKeepResponse>(&res.body).unwrap();
        assert_eq!(resp.count, 1);
    }

    #[test]
    fn test_imports_google_keep_invalid_base64() {
        let ctx = Context::with_test_database();
        let router = router(ctx.clone());
        let (_, token) = create_test_user_with_session(&ctx);

        let res = router.handle(
            &Request::post("http://localhost/api/imports/google-keep")
                .header("Authorization", format!("Bearer {token}"))
                .body("file=not-valid-base64!!!"),
        );
        assert_eq!(res.status, Status::BadRequest);
    }

    #[test]
    fn test_imports_google_keep_unauthorized() {
        let ctx = Context::with_test_database();
        let router = router(ctx.clone());

        let res = router.handle(
            &Request::post("http://localhost/api/imports/google-keep").body("file=dGVzdA=="),
        );
        assert_eq!(res.status, Status::Unauthorized);
    }
}
